#!/usr/bin/env ruby

require 'httparty'
require 'json'
require 'mini_magick'
require 'nokogiri'
require 'pry'
require 'securerandom'
require 'thor'

class String
  def as_img_path
    downcase.gsub(/\s/, '_').gsub(/\W/, '').gsub(/_{2,}/, '_')
  end
end

class ScraperTeams < Thor
  DATA_FOLDER = "#{File.dirname __FILE__}/../data"

  BASE_URL = 'https://www.comunidadairsoftmexico.org/consulta.php?estado='

  desc 'images', 'Process team images'
  def images
    Dir
      .children('./public/teams/originals')
      .each do |file|
        print '.'

        image = MiniMagick::Image.open "./public/teams/originals/#{file}"
        image.resize '36x36'

        extname = file.split('.').last
        resized_img = file.gsub extname, "_36x36.#{extname}"
        image.write "./public/teams/#{resized_img}"
      end
  end

  desc 'scrap', 'Scrap teams information'
  def scrap
    teams = [
      'Aguascalientes',
      'Baja California',
      'Baja California Sur',
      'Campeche',
      'Chiapas',
      'Chihuahua',
      'Ciudad de Mexico',
      'Coahuila',
      'Colima',
      'Durango',
      'Estado de Mexico',
      'Guanajuato',
      'Guerrero',
      'Hidalgo',
      'Jalisco',
      'Michoacan',
      'Morelos',
      'Nayarit',
      'Nuevo Leon',
      'Oaxaca',
      'Puebla',
      'Queretaro',
      'Quintana Roo',
      'San Luis Potosi',
      'Sinaloa',
      'Sonora',
      'Tabasco',
      'Tamaulipas',
      'Tlaxcala',
      'Veracruz',
      'Yucatan',
      'Zacatecas',
    ].flat_map do |state|
      print '.'

      res = HTTParty.get(
        "#{BASE_URL}#{state}",
        headers: {
          'User-Agent' => 'Mozilla/5.0 (X11; Linux x86_64; rv:142.0) Gecko/20100101 Firefox/142.0',
          'Accept' => 'text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8',
          'Accept-Language' => 'en-US,en;q=0.5',
          'Accept-Encoding' => 'gzip, deflate, br, zstd',
        }
      )

      doc = Nokogiri::HTML res.body
      doc.css('div a').zip(doc.css('div img')).map do |a, img|
        next if a.text.empty?

        extname = img['src'].split('.').last
        filename = "#{a.text.as_img_path}_36x36.#{extname}"

        `wget --quiet #{img['src']} --output-document ./public/teams/#{filename}`

        {
          name: a.text,
          url: a['href'],
          img_url: "/teams/#{filename}",
          state: state,
        }
      end
    end

    File.write "#{DATA_FOLDER}/teams.json", teams.compact.to_json

    puts '[+] Done!'
  end

  desc 'gensql OWNER_ID', 'Generate SQL insert for the seeds'
  def gensql(owner_id)
    recs = JSON.parse File.read("#{DATA_FOLDER}/teams.json")

    queries = recs.map do |r|
      "('#{SecureRandom.uuid}', '#{owner_id}', '#{r["name"].gsub "'", "\\'"}', '#{r["state"]}', '#{r["url"]}', '#{r["img_url"]}')"
    end

    puts "INSERT INTO teams(id, owner_id, name, state, page_url, logo_url) VALUES\n#{queries.join ",\n"};"
  end
end

ScraperTeams.start ARGV
